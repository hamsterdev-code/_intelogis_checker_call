"""
–°–µ—Ä–≤–µ—Ä–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–æ–≤
–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –∫–∞–∂–¥—ã–π —á–∞—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ API,
–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
"""

import time
import requests
import tempfile
import os

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º oneDNN (MKL-DNN) –∏ NNPACK –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫
# –†–µ—à–µ–Ω–∏–µ –∏–∑: https://github.com/intel/intel-extension-for-pytorch/issues/488
# –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –î–û –∏–º–ø–æ—Ä—Ç–∞ torch –∏ whisper
os.environ['MKLDNN_VERBOSE'] = '0'
os.environ['MKL_VERBOSE'] = '0'
# –û—Ç–∫–ª—é—á–∞–µ–º oneDNN –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∏–º–∏—Ç–∏–≤–∞–º–∏
os.environ['TORCH_ALLOW_TF32_CUBLAS_OVERRIDE'] = '0'
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö oneDNN
os.environ['ONEDNN_VERBOSE'] = '0'
# –û—Ç–∫–ª—é—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ oneDNN (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ issue #488)
os.environ['MKLDNN_ENABLED'] = '0'
# –û—Ç–∫–ª—é—á–∞–µ–º NNPACK –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ "Could not initialize NNPACK! Reason: Unsupported hardware"
os.environ['USE_NNPACK'] = '0'
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è NNPACK
os.environ['PYTORCH_DISABLE_NNPACK'] = '1'
# –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è NNPACK —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ['PYTORCH_NNPACK_DISABLED'] = '1'

from openai import OpenAI
import json
import logging
from datetime import datetime
import sqlite3
from contextlib import contextmanager
from typing import List, Dict, Optional
import traceback
import httpx

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PyTorch –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ "could not create a primitive"
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
# –í–ê–ñ–ù–û: torch –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –î–û whisper
import torch
import torch.multiprocessing as mp

# –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è NNPACK —á–µ—Ä–µ–∑ warnings
import warnings
# –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ NNPACK
warnings.filterwarnings('ignore', message='.*NNPACK.*')
warnings.filterwarnings('ignore', message='.*Could not initialize NNPACK.*')
warnings.filterwarnings('ignore', message='.*Unsupported hardware.*')
# –¢–∞–∫–∂–µ –ø–æ–¥–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—é UserWarning
warnings.filterwarnings('ignore', category=UserWarning, message='.*NNPACK.*')

# –¢–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º whisper –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PyTorch
import whisper

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º oneDNN –∏ NNPACK —á–µ—Ä–µ–∑ PyTorch (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
try:
    # –û—Ç–∫–ª—é—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ oneDNN backend
    torch.backends.mkldnn.enabled = False
except AttributeError:
    pass  # –ê—Ç—Ä–∏–±—É—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö

# –û—Ç–∫–ª—é—á–∞–µ–º NNPACK —á–µ—Ä–µ–∑ PyTorch API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
try:
    # –û—Ç–∫–ª—é—á–∞–µ–º NNPACK –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
    if hasattr(torch.backends, 'nnpack'):
        torch.backends.nnpack.enabled = False
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ _nnpack
    if hasattr(torch, '_nnpack'):
        torch._nnpack = None
except (AttributeError, TypeError):
    pass  # –ê—Ç—Ä–∏–±—É—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è NNPACK —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤ PyTorch
try:
    # –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è NNPACK –≤ –ª–æ–≥–∞—Ö PyTorch
    torch_logger = logging.getLogger('torch')
    torch_logger.setLevel(logging.ERROR)  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏, –Ω–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
except:
    pass

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–æ–¥ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (spawn –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª–µ–Ω –Ω–∞ Linux)
try:
    mp.set_start_method('spawn', force=True)
except RuntimeError:
    pass  # –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ PyTorch –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
torch.set_num_threads(1)
torch.set_num_interop_threads(1)

# ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ config.py
from config import (
    API_GET_CALLS,
    API_POST_RESULTS,
    API_BASE_URL,
    CALLS_COUNT,
    TEMP_DIRECTORY,
    DATABASE_PATH,
    LOG_FILE,
    OPENAI_API_KEY,
    OPENAI_BASE_URL,
    OPENAI_MODEL,
    WHISPER_MODEL_SIZE,
    WHISPER_LANGUAGE,
    WHISPER_BEAM_SIZE,
    WHISPER_DEVICE,
    WHISPER_CPU_THREADS,
    SCHEDULE_INTERVAL_HOURS,
    RUN_ON_STARTUP,
    AUDIO_DOWNLOAD_TIMEOUT,
    API_REQUEST_TIMEOUT,
    SEND_RESULTS_DELAY,
    CONSOLE_LOG_LEVEL,
    FILE_LOG_LEVEL,
    LOG_TRANSCRIBED_TEXT,
    API_AUTH_TOKEN,
    API_COOKIE_DDG1,
    API_COOKIE_JWT_CHECK,
    API_COOKIE_PHPSESSID,
    BASE_DIR
)

# ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
auth_token = API_AUTH_TOKEN
cookie_ddg1 = API_COOKIE_DDG1
cookie_jwt_check = API_COOKIE_JWT_CHECK
cookie_phpsessid = API_COOKIE_PHPSESSID

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è cookies
api_session = requests.Session()


def update_session_auth():
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏
    """
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    api_session.headers.update({
        'Authorization': f'Bearer {auth_token}',
        'accept': 'application/json, text/plain, */*',
        'accept-language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
        'origin': 'https://dl-ils.intelogis.ru',
        'referer': 'https://dl-ils.intelogis.ru/',
        'sec-ch-ua': '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
        'sec-ch-ua-mobile': '?0',
        'sec-ch-ua-platform': '"Windows"',
        'sec-fetch-dest': 'empty',
        'sec-fetch-mode': 'cors',
        'sec-fetch-site': 'same-site',
        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
    })
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookies
    api_session.cookies.update({
        '__ddg1_': cookie_ddg1,
        'jwtCheck6925a697e90a5': cookie_jwt_check,
        'PHPSESSID': cookie_phpsessid,
    })


def refresh_auth():
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
    """
    logger.error("‚ùå Not authorized! Token refresh required.")
    raise Exception("Not authorized. Need to refresh authorization tokens.")


def make_authenticated_request(method: str, url: str, **kwargs) -> requests.Response:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç requests.Session –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è cookies
    –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
    
    Args:
        method: HTTP –º–µ—Ç–æ–¥ (GET, POST, –∏ —Ç.–¥.)
        url: URL –∑–∞–ø—Ä–æ—Å–∞
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è requests
        
    Returns:
        Response –æ–±—ä–µ–∫—Ç
        
    Raises:
        Exception: –ü—Ä–∏ –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    """
    # Log request (without tokens in logs)
    logger.debug(f"API request: {method} {url}")
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Å–µ—Å—Å–∏—é
    response = api_session.request(method, url, **kwargs)
    
    # Check authorization status
    if response.status_code == 401:
        logger.warning("‚ö†Ô∏è Received 401 Unauthorized status. Attempting to refresh tokens...")
        refresh_auth()  # This will raise an exception, logic not implemented yet
        
    return response

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================

# –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä
logger = logging.getLogger("CallsAnalyzer")
logger.setLevel(logging.INFO)

# –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ handlers
logger.handlers.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞ (–¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
file_handler = logging.FileHandler(LOG_FILE, encoding='utf-8')
file_handler.setLevel(getattr(logging, FILE_LOG_LEVEL))
file_formatter = logging.Formatter(
    '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
file_handler.setFormatter(file_formatter)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ (–∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
console_handler = logging.StreamHandler()
console_handler.setLevel(getattr(logging, CONSOLE_LOG_LEVEL))
console_formatter = logging.Formatter(
    '%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%H:%M:%S'
)
console_handler.setFormatter(console_formatter)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
logger.addHandler(file_handler)
logger.addHandler(console_handler)

# –û—Ç–∫–ª—é—á–∞–µ–º propagation
logger.propagate = False

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
if not OPENAI_API_KEY or OPENAI_API_KEY.strip() == "":
    logger.error("‚ùå OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY")
    logger.error("   –ù–∞ Ubuntu: export OPENAI_API_KEY='–≤–∞—à_–∫–ª—é—á' –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª")
    raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (OpenRouter –∫–ª—é—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å "sk-or-v1-")
if not OPENAI_API_KEY.startswith("sk-or-v1-") and not OPENAI_API_KEY.startswith("sk-"):
    logger.warning("‚ö†Ô∏è API –∫–ª—é—á –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É OpenRouter (–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'sk-or-v1-')")
    logger.warning("   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –æ—Ç OpenRouter")

# –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ (–º–∞—Å–∫–∏—Ä—É–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
masked_key = OPENAI_API_KEY[:10] + "..." + OPENAI_API_KEY[-4:] if len(OPENAI_API_KEY) > 14 else "***"
logger.info(f"üîë –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenRouter API –∫–ª—é—á: {masked_key}")
logger.info(f"üåê OpenRouter URL: {OPENAI_BASE_URL}")
logger.info(f"ü§ñ –ú–æ–¥–µ–ª—å: {OPENAI_MODEL}")

# OpenAI –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞ (OpenRouter)
# –°–æ–∑–¥–∞–µ–º httpx –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º proxies
# –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è OpenRouter (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∫–ª—é—á–∞–º–∏)
http_client = httpx.Client(
    timeout=60.0,
    headers={
        "HTTP-Referer": "https://github.com/intelogis/call_checker",  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è OpenRouter
        "X-Title": "Intelogis Call Checker",  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è OpenRouter
    },
    follow_redirects=True,
)
client = OpenAI(
    base_url=OPENAI_BASE_URL,
    api_key=OPENAI_API_KEY,
    http_client=http_client,
)

# –ú–æ–¥–µ–ª—å Whisper (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
whisper_model = None
whisper_device = None


def detect_device():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    if WHISPER_DEVICE != "auto":
        return WHISPER_DEVICE
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ CUDA (torch —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å whisper)
    try:
        import torch
        if torch.cuda.is_available():
            logger.info("‚úÖ CUDA (GPU) support detected")
            return "cuda"
    except ImportError:
        pass
    
    logger.info("‚ÑπÔ∏è CUDA not available, using CPU")
    return "cpu"


def load_whisper_model():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å Whisper –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)"""
    global whisper_model, whisper_device
    
    # If model is already loaded, just return it (without reloading)
    if whisper_model is not None:
        logger.info("‚úÖ Model already loaded, reusing from memory (without reloading)")
        return whisper_model
    
    try:
        device = detect_device()
        whisper_device = device
        
        logger.info(f"Loading Whisper model ({WHISPER_MODEL_SIZE})...")
        logger.info(f"Device: {device}")
        logger.info("‚è≥ Loading model into memory...")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        # –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ "could not create a primitive"
        whisper_model = whisper.load_model(WHISPER_MODEL_SIZE, device=device)
        
        logger.info("‚úÖ Whisper model loaded successfully and will be reused")
            
    except Exception as e:
        logger.error(f"‚ùå Error loading Whisper model: {str(e)}")
        logger.error(f"‚ùå Error type: {type(e).__name__}")
        logger.error(f"‚ùå Error details: {traceback.format_exc()}")
        logger.error("üí° Try:")
        logger.error("   1. Check internet connection")
        logger.error("   2. Use smaller model: WHISPER_MODEL_SIZE=base")
        logger.error("   3. Install library: pip install openai-whisper")
        logger.error("   4. Set WHISPER_DEVICE=cpu to force CPU mode")
        logger.error("   5. Check available memory (model may be too large)")
        # –ù–ï –¥–µ–ª–∞–µ–º raise - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None, —á—Ç–æ–±—ã –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —É–ø–∞–ª
        # –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ–∑–∂–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
        logger.warning("‚ö†Ô∏è Model loading failed, will retry on first use")
        whisper_model = None
        whisper_device = None
    
    return whisper_model


# ==================== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ====================

@contextmanager
def get_db():
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î"""
    conn = sqlite3.connect(DATABASE_PATH)
    conn.row_factory = sqlite3.Row
    try:
        yield conn
        conn.commit()
    except Exception:
        conn.rollback()
        raise
    finally:
        conn.close()


def init_database():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç"""
    with get_db() as conn:
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –∑–≤–æ–Ω–∫–æ–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS analyzed_calls (
                id INTEGER PRIMARY KEY,
                call_id INTEGER UNIQUE NOT NULL,
                audio_url TEXT,
                transcription TEXT,
                criteria TEXT,
                analyzed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                sent_to_api BOOLEAN DEFAULT 0,
                sent_at TIMESTAMP
            )
        """)
        
        # –ò–Ω–¥–µ–∫—Å—ã
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_call_id ON analyzed_calls(call_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_sent_to_api ON analyzed_calls(sent_to_api)")
        
        conn.commit()
        logger.info("‚úÖ Database initialized")


# ==================== –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê ====================

def transcribe_audio(url: str) -> str:
    """
    –°–∫–∞—á–∏–≤–∞–µ—Ç MP3 —Ñ–∞–π–ª –ø–æ URL –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ —Ç–µ–∫—Å—Ç
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI Whisper –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    """
    temp_file_path = None
    try:
        logger.info(f"Downloading audio: {url}")
        
        # Download file (with authorization if it's our API)
        if 'intelogis.ru' in url or 'saas.intelogis.ru' in url:
            # This is our API - use authorization
            response = make_authenticated_request('GET', url, timeout=AUDIO_DOWNLOAD_TIMEOUT)
        else:
            # External URL - without authorization
            response = requests.get(url, timeout=AUDIO_DOWNLOAD_TIMEOUT)
        response.raise_for_status()
        
        # Save to temporary file
        with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3", dir=TEMP_DIRECTORY) as tmp_file:
            tmp_file.write(response.content)
            temp_file_path = tmp_file.name
        
        logger.info(f"Audio saved: {temp_file_path}")
        
        # Get model (already loaded at startup, reuse)
        # Use global variable directly to avoid unnecessary calls
        if whisper_model is None:
            logger.warning("‚ö†Ô∏è Model not loaded! Loading now...")
            # Retry loading with exponential backoff
            max_retries = 3
            retry_delay = 5
            for attempt in range(max_retries):
                try:
                    load_whisper_model()
                    if whisper_model is not None:
                        logger.info(f"‚úÖ Model loaded successfully on attempt {attempt + 1}")
                        break
                    else:
                        if attempt < max_retries - 1:
                            logger.warning(f"‚ö†Ô∏è Model loading failed, retrying in {retry_delay} seconds... (attempt {attempt + 1}/{max_retries})")
                            time.sleep(retry_delay)
                            retry_delay *= 2  # Exponential backoff
                        else:
                            logger.error("‚ùå Failed to load model after all retries")
                            raise Exception("Whisper model could not be loaded after multiple attempts")
                except Exception as e:
                    if attempt < max_retries - 1:
                        logger.warning(f"‚ö†Ô∏è Model loading error: {str(e)}, retrying in {retry_delay} seconds... (attempt {attempt + 1}/{max_retries})")
                        time.sleep(retry_delay)
                        retry_delay *= 2
                    else:
                        logger.error(f"‚ùå Failed to load model after {max_retries} attempts: {str(e)}")
                        raise
        
        if whisper_model is None:
            raise Exception("Whisper model is not available")
        
        model = whisper_model
        logger.info("‚úÖ Using already loaded Whisper model (without reloading)")
        
        # Transcribe speech
        transcribe_start = time.time()
        logger.info("Transcribing speech...")
        
        # Set transcription parameters
        transcribe_kwargs = {
            "language": WHISPER_LANGUAGE,
            "task": "transcribe",
            "temperature": 0.0,
            "best_of": 1
        }
        
        # –î–ª—è CPU —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º fp16=False, –¥–ª—è CUDA –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fp16
        if whisper_device == "cpu":
            transcribe_kwargs["fp16"] = False
        elif whisper_device == "cuda":
            transcribe_kwargs["fp16"] = True
        
        result = model.transcribe(temp_file_path, **transcribe_kwargs)
        text = result["text"].strip()
        
        transcribe_duration = time.time() - transcribe_start
        logger.info(f"‚úÖ Text transcribed ({len(text)} characters) in {transcribe_duration:.2f} sec")
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
        if LOG_TRANSCRIBED_TEXT:
            logger.info(f"üìù Transcribed text: {text}")
        
        return text
        
    except Exception as e:
        logger.error(f"‚ùå Error during transcription: {str(e)}")
        logger.debug(traceback.format_exc())
        raise
    finally:
        # Delete temporary file
        if temp_file_path and os.path.exists(temp_file_path):
            try:
                os.unlink(temp_file_path)
                logger.debug(f"Temporary file deleted: {temp_file_path}")
            except Exception as e:
                logger.warning(f"Failed to delete temporary file: {str(e)}")


def load_scripts():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ —Ñ–∞–π–ª–∞ —Å–∫—Ä–∏–ø—Ç—ã.txt"""
    scripts_file = BASE_DIR / "scripts.txt"
    try:
        with open(scripts_file, 'r', encoding='utf-8') as f:
            return f.read()
    except Exception as e:
        logger.warning(f"Failed to load scripts from file: {str(e)}")
        return ""


def is_empty_transcription(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç—ã–º (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∞ –∑–≤–æ–Ω–∫–∞ –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è)
    
    Args:
        text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞
        
    Returns:
        True –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∞), False –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
    """
    if not text:
        return True
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    normalized = text.strip().upper()
    
    # –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    normalized_clean = normalized.replace("!", "").replace(".", "").replace(",", "").replace("?", "").replace(":", "").replace(";", "")
    
    # –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (–º–µ—Ç–∫–∏ –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è) - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    empty_patterns = [
        "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö",
        "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö",
        "–¢–ï–õ–ï–§–û–ù–ù–´–ô–ó–í–û–ù–û–ö",
        "–¢–ï–õ–ï–§–û–ù–ù–´–ô–ì–£–î–û–ö",
        "–ó–í–û–ù–û–ö",
        "–ì–£–î–û–ö",
        "–¢–ï–õ–ï–§–û–ù–ù–´–ô",
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ (—Å —É—á–µ—Ç–æ–º –∏ –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ–±–µ–ª–æ–≤)
    if normalized in empty_patterns or normalized_clean in empty_patterns:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ –∏–∑ –º–µ—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö" –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ)
    words = normalized_clean.split()
    if len(words) <= 3:  # –ï—Å–ª–∏ —Å–ª–æ–≤ –º–∞–ª–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è—é—Ç—Å—è –ª–∏ –æ–Ω–∏ —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∞–º–∏
        if all(word in ["–¢–ï–õ–ï–§–û–ù–ù–´–ô", "–ó–í–û–ù–û–ö", "–ì–£–î–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô–ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô–ì–£–î–û–ö"] for word in words):
            return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã (–º–µ–Ω–µ–µ 15 —Å–∏–º–≤–æ–ª–æ–≤) –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
    # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –±–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
    if len(normalized) < 15:
        # –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
        greetings_only = [
            "–ó–î–†–ê–í–°–¢–í–£–ô–¢–ï",
            "–ó–î–†–ê–í–°–¢–í–£–ô–¢–ï!",
            "–î–û–ë–†–´–ô –î–ï–ù–¨",
            "–î–û–ë–†–´–ô –î–ï–ù–¨!",
            "–î–û–ë–†–´–ô –í–ï–ß–ï–†",
            "–î–û–ë–†–´–ô –í–ï–ß–ï–†!",
            "–ê–õ–õ–û",
            "–ê–õ–õ–û!",
            "–ü–†–ò–í–ï–¢",
            "–ü–†–ò–í–ï–¢!",
        ]
        if normalized in greetings_only or normalized_clean in greetings_only:
            return True
    
    return False


def analyze_call_text(text: str, team: str = "") -> Dict:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ OpenRouter AI
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏
    
    Args:
        text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞
        team: –ö–æ–º–∞–Ω–¥–∞ –ª–æ–≥–∏—Å—Ç–∞ (–¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
    """
    # Check if text is empty (only label without content)
    if is_empty_transcription(text):
        logger.warning(f"‚ö†Ô∏è Empty text detected (label only): '{text}'")
        logger.info("Returning zero criteria (0,0,0,0) without AI call")
        return {
            'criteria_1': 0.0,
            'criteria_2': 0.0,
            'criteria_3': 0.0,
            'criteria_4': 0.0
        }
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ - –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 5, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0,0,0,0
    words = text.strip().split()
    word_count = len([w for w in words if w.strip()])  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    if word_count <= 5:
        logger.warning(f"‚ö†Ô∏è Text has {word_count} words (<= 5): '{text}'")
        logger.info("Returning zero criteria (0,0,0,0) without AI call")
        return {
            'criteria_1': 0.0,
            'criteria_2': 0.0,
            'criteria_3': 0.0,
            'criteria_4': 0.0
        }
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã
    scripts_content = load_scripts()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å —É—á–µ—Ç–æ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
    team_info = f"\n–ö–æ–º–∞–Ω–¥–∞ –ª–æ–≥–∏—Å—Ç–∞: {team}" if team else ""
    scripts_section = f"\n\n–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏:\n{scripts_content}" if scripts_content else ""
    
    prompt = f"""–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ä–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. –≠—Ç–æ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –¶–≠ (–ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è, –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞–º–∏ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –º–∞—Ä—à—Ä—É—Ç–æ–≤) –∏ –æ—Ü–µ–Ω–∏ –µ–≥–æ –ø–æ 4 –∫—Ä–∏—Ç–µ—Ä–∏—è–º.{team_info}

–¢–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞:
{text}
{scripts_section}

‚ö†Ô∏è –í–ê–ñ–ù–û: –ë—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º! ‚ö†Ô∏è

–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û –º–µ—Ç–∫—É "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö", "–ó–í–û–ù–û–ö", "–ì–£–î–û–ö" –∏–ª–∏ –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è ("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–î–æ–±—Ä—ã–π –¥–µ–Ω—å", "–ê–ª–ª–æ" –∏ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ) - –í–°–ï –ö–†–ò–¢–ï–†–ò–ò –î–û–õ–ñ–ù–´ –ë–´–¢–¨ 0.0!

–ù–û: –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å—Ç—å –¥–∏–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—Ç—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ - —ç—Ç–æ –°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–´–ô –∑–≤–æ–Ω–æ–∫, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ê–ª–ª–æ"!
–í —Ç–µ–∫—Å—Ç–µ –Ω–µ –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –±—ã–ª –ª–∏ –¥–∏–∞–ª–æ–≥ (–ø–æ—Å—Ç–∞—Ä–∞—Ç—å—Å—è –ø–æ–Ω—è—Ç—å). –∏–Ω–æ–≥–¥–∞ —É –ª—é–¥–µ–π –ø–ª–æ—Ö–æ–ª–π –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–≤–∞ —Ç–µ—Ä—è—é—Ç—å—Å—è.
–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏:

1. **–ö—Ä–∏—Ç–µ—Ä–∏–π 1 (call_was_made)**: –ë—ã–ª –ª–∏ —Å–æ–≤–µ—Ä—à–µ–Ω –∑–≤–æ–Ω–æ–∫, –Ω–µ —è–≤–ª—è–ª—Å—è –ª–∏ –æ–Ω –ø—É—Å—Ç—ã–º?
   
   ‚ö†Ô∏è –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ - –°–¢–ê–í–¨ 0.0! –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–∂–µ –ø—Ä–æ—à–µ–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, –Ω–æ –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –æ–Ω –¥–æ—à–µ–ª –¥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ - —Å—Ç–∞–≤—å 0.0!
   
   ‚ö†Ô∏è –°–¢–ê–í–¨ 0.0 –¢–û–õ–¨–ö–û –ï–°–õ–ò:
   - –í —Ç–µ–∫—Å—Ç–µ 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ
   - –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö", "–ó–í–û–ù–û–ö", "–ì–£–î–û–ö" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –º–µ—Ç–∫–∏
   - –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ë–ï–ó –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" (–∏ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ), "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" (–∏ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ), "–ê–ª–ª–æ" (–∏ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ)
   - –¢–æ–ª—å–∫–æ –∑–≤—É–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
   - –¢–∏—à–∏–Ω–∞ –∏–ª–∏ –Ω–µ–∑–Ω–∞—á–∞—â–∏–µ –∑–≤—É–∫–∏
   
   ‚úÖ –°–¢–ê–í–¨ 1.0 –ï–°–õ–ò:
   - –í —Ç–µ–∫—Å—Ç–µ –ë–û–õ–¨–®–ï 5 —Å–ª–æ–≤ –ò –±—ã–ª —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –æ–±–º–µ–Ω–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º –¥–µ—Ç–∞–ª–µ–π
   - –ï—Å—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≤–æ–ø—Ä–æ—Å/–∑–∞–ø—Ä–æ—Å + –æ—Ç–≤–µ—Ç + —Ö–æ—Ç—è –±—ã –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–µ–º—ã
   - –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ê–ª–ª–æ" –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –Ω–æ –î–ê–õ–¨–®–ï –µ—Å—Ç—å –¥–∏–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—Ç—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ - —ç—Ç–æ –°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–´–ô –∑–≤–æ–Ω–æ–∫! –°—Ç–∞–≤—å 1.0!
   - –ï—Å—Ç—å –æ–±–º–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç –±–æ–ª—å—à–µ –¥—Ä—É–≥–æ–≥–æ)
   - –û–±—Å—É–∂–¥–∞—é—Ç—Å—è –ª—é–±—ã–µ —Ç–µ–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–±–æ—Ç–æ–π –∏–ª–∏ —É—Å–ª—É–≥–∞–º–∏
   
   –ü–†–ò–ú–ï–†–´ –°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–û–ì–û –ó–í–û–ù–ö–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å—Ç–∞–≤—å 1.0):
   - "–ê–ª–ª–æ! –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á! –ú–µ–Ω—è –∑–æ–≤—É—Ç –õ—é–±–∞, –∫–æ–º–ø–∞–Ω–∏—è ¬´–í–µ–∂–µ —Ç–æ—Ç —Ä–∞–∑¬ª. –•–æ—Ç–µ–ª–∞ –±—ã –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –≤–∞–º–∏ –ø–æ –ø–æ–≤–æ–¥—É —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤ —Å –õ–∏–ø–µ—Ü–∫–∞. –£ –Ω–∞—Å –ø—Ä–∏—à–ª–∞ —Ä–∞—Å—à–∏—Ä–æ—á–∫–∞, —Ç–∞–º –º–Ω–æ–≥–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤ —Å –õ–∏–ø–µ—Ü–∫–∞ –Ω–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –Ω–∞ –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É, –Ω–∞ –°–∞–º–∞—Ä—É..." ‚Üí 1.0 (–µ—Å—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö —Ç–µ–º - —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ–π—Å—ã, –º–∞—Ä—à—Ä—É—Ç—ã)
   - "–ê–ª–ª–æ. –ë–æ—Ä–∏—Å, —è –≤–∞–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–≤–æ–Ω–∏–ª–∞, –Ω–µ —É—Ç–æ—á–Ω–∏–ª–∞ –≤–∞—à –∫–æ–¥ –í–∞—Ç–∏. –ß—Ç–æ-—Ç–æ —Å–ª—ã—à–Ω–æ –ø–ª–æ—Ö–æ. –ü–ª–æ—Ö–æ —Å–ª—ã—à–Ω–æ, –¥–∞? –ê –≤–∞—à –∫–æ–¥ –í–∞—Ç–∏ –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å? ... 2385, 525. –í—Å—ë, –ø–æ–Ω—è–ª–∞. –°–ø–∞—Å–∏–±–æ." ‚Üí 1.0 (–µ—Å—Ç—å –¥–∏–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—Ç—ã, –æ–±–º–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π)
   - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≤–æ–ø—Ä–æ—Å –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ/—É—Å–ª—É–≥–∞—Ö/–∫–æ–¥–∞—Ö/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö + –æ—Ç–≤–µ—Ç (–¥–∞–∂–µ "–Ω–µ—Ç") + –æ–±—Å—É–∂–¥–µ–Ω–∏–µ = —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ‚Üí 1.0
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, —É—Å–ª–æ–≤–∏–π, –∫–æ–¥–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –¥–∞–∂–µ –∫–æ—Ä–æ—Ç–∫–æ–µ, –Ω–æ —Å –æ–±–º–µ–Ω–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π = —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ‚Üí 1.0
   - –õ—é–±–æ–π –¥–∏–∞–ª–æ–≥, –≥–¥–µ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –æ—Ç –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏ –æ—Ç–≤–µ—Ç—ã –æ—Ç –¥—Ä—É–≥–æ–≥–æ, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–µ–º—ã = —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ‚Üí 1.0
2. **–ö—Ä–∏—Ç–µ—Ä–∏–π 2 (work_related)**: –ë—ã–ª –ª–∏ –∑–≤–æ–Ω–æ–∫ —Ä–µ–∞–ª—å–Ω–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º —Ä–∞–±–æ—á–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤?
   
   ‚ö†Ô∏è –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ - –°–¢–ê–í–¨ 0.0! –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–∂–µ –ø—Ä–æ—à–µ–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, –Ω–æ –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –æ–Ω –¥–æ—à–µ–ª –¥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ - —Å—Ç–∞–≤—å 0.0!
   
   ‚ö†Ô∏è –°–¢–ê–í–¨ 0.0 –¢–û–õ–¨–ö–û –ï–°–õ–ò:
   - –í —Ç–µ–∫—Å—Ç–µ 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ
   - –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –º–µ—Ç–∫–∏
   - –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—á–∏—Ö —Ç–µ–º
   - –†–∞–∑–≥–æ–≤–æ—Ä —è–≤–Ω–æ –ª–∏—á–Ω—ã–π (—Å –¥—Ä—É–∑—å—è–º–∏, —Å–µ–º—å–µ–π, –Ω–µ —Å–≤—è–∑–∞–Ω —Å —Ä–∞–±–æ—Ç–æ–π)
   - –¢–æ–ª—å–∫–æ –∑–≤—É–∫–∏ –∑–≤–æ–Ω–∫–∞ –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
   - –í —Ç–µ–∫—Å—Ç–µ –ù–ï–¢ —Å–ª–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∞–±–æ—Ç–æ–π –≤ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
   
   ‚úÖ –°–¢–ê–í–¨ 1.0 –ï–°–õ–ò:
   - –í —Ç–µ–∫—Å—Ç–µ –ë–û–õ–¨–®–ï 5 —Å–ª–æ–≤ –ò –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π –∏ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞–º–∏
   - –í —Ç–µ–∫—Å—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–ª–æ–≤–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–±–æ—Ç–æ–π –≤ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ (—Ç—ã —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—à—å —ç—Ç–∏ —Å–ª–æ–≤–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É)
   - –û–±—Å—É–∂–¥–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
   - –ï—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã
   - –û–±—Å—É–∂–¥–∞—é—Ç—Å—è –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞–º–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º, –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –∑–∞—è–≤–∫–∞–º–∏, –º–∞—Ä—à—Ä—É—Ç–∞–º–∏, —Ä–µ–π—Å–∞–º–∏, –≥–æ—Ä–æ–¥–∞–º–∏, –∫–æ–¥–∞–º–∏, –Ω–æ–º–µ—Ä–∞–º–∏, —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏
   - –û–±—Å—É–∂–¥–∞—é—Ç—Å—è: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞, —Ç–∏–ø—ã –º–∞—à–∏–Ω (—Ç—Ä–∞–ª–ª—ã, —Ñ—É—Ä—ã, —Ç–µ–Ω—Ç—ã, —Ä–µ—Ñ—ã, –∏–∑–æ—Ç–µ—Ä–º—ã, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Ç.–¥.)
   - –í–æ–ø—Ä–æ—Å—ã –æ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, –¥–æ—Å—Ç–∞–≤–∫–µ, –ª–æ–≥–∏—Å—Ç–∏–∫–µ, –º–∞—Ä—à—Ä—É—Ç–∞—Ö, —Ä–µ–π—Å–∞—Ö
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∑–∞—è–≤–æ–∫, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–∑–æ–∫, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏
   - –í–æ–ø—Ä–æ—Å—ã –æ –Ω–∞–ª–∏—á–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö, —Ü–µ–Ω–∞—Ö, —Å—Ä–æ–∫–∞—Ö
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ –∫–æ–¥–æ–≤, –Ω–æ–º–µ—Ä–æ–≤, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ (–∫–æ–¥—ã –í–∞—Ç–∏, –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–æ–∫, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.)
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤, –º–∞—Ä—à—Ä—É—Ç–æ–≤, –≥–æ—Ä–æ–¥–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
   - –õ—é–±—ã–µ —Ä–∞–±–æ—á–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∫–æ–º–ø–∞–Ω–∏–∏
   
   –í–ê–ñ–ù–û: –¢—ã –¥–æ–ª–∂–µ–Ω —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–ª–æ–≤–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–±–æ—Ç–æ–π –≤ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. –ï—Å–ª–∏ —Ç–∞–∫–∏–µ —Å–ª–æ–≤–∞ –µ—Å—Ç—å –∏ –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã - —ç—Ç–æ –†–ê–ë–û–ß–ò–ô –∑–≤–æ–Ω–æ–∫, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ!
   
   –ü–†–ò–ú–ï–†–´ –†–ê–ë–û–ß–ï–ì–û –ó–í–û–ù–ö–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å—Ç–∞–≤—å 1.0):
   - "–ê–ª–ª–æ! –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á! –ú–µ–Ω—è –∑–æ–≤—É—Ç –õ—é–±–∞, –∫–æ–º–ø–∞–Ω–∏—è ¬´–í–µ–∂–µ —Ç–æ—Ç —Ä–∞–∑¬ª. –•–æ—Ç–µ–ª–∞ –±—ã –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –≤–∞–º–∏ –ø–æ –ø–æ–≤–æ–¥—É —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤ —Å –õ–∏–ø–µ—Ü–∫–∞. –£ –Ω–∞—Å –ø—Ä–∏—à–ª–∞ —Ä–∞—Å—à–∏—Ä–æ—á–∫–∞, —Ç–∞–º –º–Ω–æ–≥–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤ —Å –õ–∏–ø–µ—Ü–∫–∞ –Ω–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –Ω–∞ –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É, –Ω–∞ –°–∞–º–∞—Ä—É, –Ω–∞ –ö–æ—Å—Ç—Ä–æ–º—É, –Ω–∞ –í–æ–ª–≥–æ–≥—Ä–∞–¥..." ‚Üí 1.0 (–æ–±—Å—É–∂–¥–∞—é—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ–π—Å—ã, –º–∞—Ä—à—Ä—É—Ç—ã, –≥–æ—Ä–æ–¥–∞ - —ç—Ç–æ —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫)
   - "–ê–ª–ª–æ. –ë–æ—Ä–∏—Å, —è –≤–∞–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–≤–æ–Ω–∏–ª–∞, –Ω–µ —É—Ç–æ—á–Ω–∏–ª–∞ –≤–∞—à –∫–æ–¥ –í–∞—Ç–∏. ... –ê –≤–∞—à –∫–æ–¥ –í–∞—Ç–∏ –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å? ... 2385, 525." ‚Üí 1.0 (–æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è –∫–æ–¥ –í–∞—Ç–∏ - —Ä–∞–±–æ—á–∏–π –≤–æ–ø—Ä–æ—Å)
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, —Ç–∏–ø–æ–≤ –º–∞—à–∏–Ω (—Ç—Ä–∞–ª–ª—ã, —Ç–µ–Ω—Ç—ã, —Ä–µ—Ñ—ã –∏ —Ç.–¥.) ‚Üí 1.0
   - –í–æ–ø—Ä–æ—Å—ã –æ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, –¥–æ—Å—Ç–∞–≤–∫–µ, –ª–æ–≥–∏—Å—Ç–∏–∫–µ ‚Üí 1.0
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ –∫–æ–¥–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –Ω–æ–º–µ—Ä–æ–≤, —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ ‚Üí 1.0
   - –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª "–Ω–µ—Ç" - —ç—Ç–æ –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—á–∏–π –∑–≤–æ–Ω–æ–∫, –µ—Å–ª–∏ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã! ‚Üí 1.0

3. **–ö—Ä–∏—Ç–µ—Ä–∏–π 3 (script_compliance)**: –ù–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–µ–ª –¥–∏–∞–ª–æ–≥ –ø–æ —Å–∫—Ä–∏–ø—Ç—É - —Å—Ü–µ–Ω–∞—Ä–∏—é?
   
   ‚ö†Ô∏è –°–¢–ê–í–¨ 0.0 –¢–û–õ–¨–ö–û –ï–°–õ–ò:
   - –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –º–µ—Ç–∫–∏
   - –ï—Å–ª–∏ –∫—Ä–∏—Ç–µ—Ä–∏–π 1 = 0.0 (–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞) –∏–ª–∏ –∫—Ä–∏—Ç–µ—Ä–∏–π 2 = 0.0 (–Ω–µ —Ä–∞–±–æ—á–∏–π –∑–≤–æ–Ω–æ–∫)
   - –°–∫—Ä–∏–ø—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω (–Ω–µ –∑–∞–¥–∞–Ω—ã –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ —Å–∫–∞–∑–∞–Ω–∞ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
   
   ‚úÖ –û–¶–ï–ù–ò–í–ê–ô –°–ü–†–ê–í–ï–î–õ–ò–í–û:
   - –°—Ä–∞–≤–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º, –Ω–æ –±—É–¥—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º - –Ω–µ –≤—Å–µ –∑–≤–æ–Ω–∫–∏ –º–æ–≥—É—Ç –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—É
   - –û—Ü–µ–Ω–∏ –æ—Ç 0.0 –¥–æ 1.0, –≥–¥–µ:
     - 1.0 - –∏–¥–µ–∞–ª—å–Ω–æ (–≤—Å–µ —ç—Ç–∞–ø—ã —Å–∫—Ä–∏–ø—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏, –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π, –∑–∞–¥–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã —É—Å–ª—É–≥–∏, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –≤–µ–ª —Ä–∞–∑–≥–æ–≤–æ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞)
     - 0.8-0.9 - –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ—á—Ç–∏ –≤—Å–µ —ç—Ç–∞–ø—ã, –Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã)
     - 0.6-0.7 - —Ö–æ—Ä–æ—à–æ (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã, –Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω—ã –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –¥–µ—Ç–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç–∞)
     - 0.4-0.5 - —Å—Ä–µ–¥–Ω–µ–µ (–≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Å–∫—Ä–∏–ø—Ç–∞, –ø—Ä–æ–ø—É—â–µ–Ω—ã –≤–∞–∂–Ω—ã–µ —ç—Ç–∞–ø—ã –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã)
     - 0.2-0.3 - –ø–ª–æ—Ö–æ (–≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∞–ª–∞—è —á–∞—Å—Ç—å —Å–∫—Ä–∏–ø—Ç–∞, –ø—Ä–æ–ø—É—â–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã)
     - 0.0 - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏: –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∑–≤–æ–Ω–∫–∞, —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∞, —Å–∫—Ä–∏–ø—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
   
   –ü—Ä–æ–≤–µ—Ä—å:
   - –ë—ã–ª–æ –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏?
   - –ë—ã–ª–æ –ª–∏ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞?
   - –ë—ã–ª–∏ –ª–∏ –∑–∞–¥–∞–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞?
   - –ë—ã–ª–∏ –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã —É—Å–ª—É–≥–∏/–∑–∞—è–≤–∫–∏?
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞?
   - –ë—ã–ª–∏ –ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ —Å–∫—Ä–∏–ø—Ç—É?
   
   –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è, –æ–±—Å—É–¥–∏–ª —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã, –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã - —ç—Ç–æ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞! –ù–µ —Å—Ç–∞–≤—å —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫—É—é –æ—Ü–µ–Ω–∫—É!

4. **–ö—Ä–∏—Ç–µ—Ä–∏–π 4 (positive_outcome)**: –î–∏–∞–ª–æ–≥ –¥–æ—à–µ–ª –¥–æ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, —Ä–µ—à–∏–ª–∏ –ª–∏ –æ–Ω–∏ —á—Ç–æ-—Ç–æ, –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫, –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è?
   
   ‚ö†Ô∏è –°–¢–ê–í–¨ 0.0 –ï–°–õ–ò:
   - –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –º–µ—Ç–∫–∏
   - –ï—Å–ª–∏ –∫—Ä–∏—Ç–µ—Ä–∏–π 1 = 0.0 (–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞) –∏–ª–∏ –∫—Ä–∏—Ç–µ—Ä–∏–π 2 = 0.0 (–Ω–µ —Ä–∞–±–æ—á–∏–π –∑–≤–æ–Ω–æ–∫)
   - –î–∏–∞–ª–æ–≥ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ (–Ω–µ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å, –æ—Ç–∫–∞–∑, –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å, –∫–ª–∏–µ–Ω—Ç –Ω–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω)
   
   ‚úÖ –°–¢–ê–í–¨ 1.0 –ï–°–õ–ò:
   - –ë—ã–ª —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∑–≤–æ–Ω–æ–∫ –ò –¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫–∞–∑/–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞, –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –Ω–∞ –∑–≤–æ–Ω–æ–∫ –≤ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è, –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ)
   - –î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –æ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö, –∑–≤–æ–Ω–∫–∞—Ö, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏

‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï:
- –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ 5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ - –í–°–ï 4 –ö–†–ò–¢–ï–†–ò–Ø –î–û–õ–ñ–ù–´ –ë–´–¢–¨ 0.0!
- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û –º–µ—Ç–∫—É —Ç–∏–ø–∞ "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ó–í–û–ù–û–ö", "–¢–ï–õ–ï–§–û–ù–ù–´–ô –ì–£–î–û–ö", "–ó–í–û–ù–û–ö", "–ì–£–î–û–ö" –∏–ª–∏ –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è - –í–°–ï 4 –ö–†–ò–¢–ï–†–ò–Ø –î–û–õ–ñ–ù–´ –ë–´–¢–¨ 0.0!
- –ù–û: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ë–û–õ–¨–®–ï 5 —Å–ª–æ–≤ –ò –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å—Ç—å –¥–∏–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—Ç—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ - —ç—Ç–æ –°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–´–ô –∑–≤–æ–Ω–æ–∫! –ö—Ä–∏—Ç–µ—Ä–∏–π 1 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1.0!
- –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ë–û–õ–¨–®–ï 5 —Å–ª–æ–≤ –ò –µ—Å—Ç—å —Å–ª–æ–≤–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–±–æ—Ç–æ–π –≤ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏, –∏ –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–µ —Ç–µ–º—ã - –∫—Ä–∏—Ç–µ—Ä–∏–π 2 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1.0!
- –ë—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º: —Å—Ç—Ä–æ–≥–∏–º –∫ –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–µ–∫—Å—Ç–∞–º (5 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ), –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º –∑–≤–æ–Ω–∫–∞–º!

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –û–ë–Ø–ó–ê–ù –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞!
–î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–∏—á–∏–Ω–µ, –≤–µ—Ä–Ω–∏ JSON —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:
{{
    "criteria_1": 0.0,
    "criteria_2": 0.0,
    "criteria_3": 0.0,
    "criteria_4": 0.0
}}

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:
{{
    "criteria_1": <—á–∏—Å–ª–æ 0.0 –∏–ª–∏ 1.0>,
    "criteria_2": <—á–∏—Å–ª–æ 0.0 –∏–ª–∏ 1.0>,
    "criteria_3": <—á–∏—Å–ª–æ –æ—Ç 0.00 –¥–æ 1.00>,
    "criteria_4": <—á–∏—Å–ª–æ 0.0 –∏–ª–∏ 1.0>
}}

–ù–ï –ø–∏—à–∏ –Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –∏–∑–≤–∏–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞ - –¢–û–õ–¨–ö–û JSON!"""

    try:
        logger.info("Analyzing text via AI...")
        logger.debug(f"Text length: {len(text)} chars")
        logger.debug(f"Text preview (first 200 chars): {text[:200]}")
        if team:
            logger.info(f"Logistics team: {team}")
        
        # Try to get response from AI
        max_retries = 2
        for attempt in range(max_retries):
            try:
                # Try to use response_format for JSON mode (if supported by model)
                # Some models support this, others don't - we'll try and fall back if needed
                request_params = {
                    "model": OPENAI_MODEL,
                    "messages": [
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ]
                }
                
                # Try to add JSON mode (may not be supported by all models/APIs)
                try:
                    request_params["response_format"] = {"type": "json_object"}
                    logger.debug("Attempting to use JSON mode (response_format)")
                except:
                    pass  # If not supported, continue without it
                
                response = client.chat.completions.create(**request_params)
                break  # Success, exit retry loop
            except Exception as e:
                error_str = str(e)
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                if "401" in error_str or "AuthenticationError" in str(type(e).__name__) or "User not found" in error_str:
                    logger.error("‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ OpenRouter API!")
                    logger.error("   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    logger.error("   1. API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫")
                    logger.error("   2. API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ Ubuntu")
                    logger.error("   3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞")
                    logger.error(f"   –¢–µ–∫—É—â–∏–π –∫–ª—é—á (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π): {OPENAI_API_KEY[:10]}...{OPENAI_API_KEY[-4:] if len(OPENAI_API_KEY) > 14 else '***'}")
                    logger.error(f"   URL: {OPENAI_BASE_URL}")
                    logger.error(f"   –ú–æ–¥–µ–ª—å: {OPENAI_MODEL}")
                    logger.error("   –†–µ—à–µ–Ω–∏–µ:")
                    logger.error("   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –Ω–∞ https://openrouter.ai/keys")
                    logger.error("   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: echo $OPENAI_API_KEY")
                    logger.error("   - –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª: OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á")
                    logger.error(f"   –ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞: {error_str}")
                    # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    raise ValueError(f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ OpenRouter API: {error_str}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á.")
                
                if attempt < max_retries - 1:
                    logger.warning(f"‚ö†Ô∏è AI request failed (attempt {attempt + 1}/{max_retries}): {str(e)}")
                    logger.warning("‚ö†Ô∏è Retrying with simplified prompt...")
                    # Use simplified prompt on retry
                    prompt = f"""Analyze this phone call transcript and return ONLY JSON with 4 criteria (0.0 to 1.0):

Text: {text[:1000]}

Return ONLY this JSON format, no other text:
{{
    "criteria_1": 0.0,
    "criteria_2": 0.0,
    "criteria_3": 0.0,
    "criteria_4": 0.0
}}"""
                    time.sleep(1)  # Small delay before retry
                else:
                    raise  # Re-raise on last attempt
        
        # Check if response is valid
        if not response or not hasattr(response, 'choices') or not response.choices:
            logger.error("‚ùå Empty or invalid response from AI API")
            raise ValueError("Empty or invalid response from AI API")
        
        # Check finish_reason - might indicate content filtering or other issues
        choice = response.choices[0]
        finish_reason = getattr(choice, 'finish_reason', None)
        if finish_reason:
            logger.debug(f"AI finish_reason: {finish_reason}")
            if finish_reason == 'content_filter':
                logger.warning("‚ö†Ô∏è AI response was filtered by content moderation")
                logger.warning("‚ö†Ô∏è This might indicate the content triggered safety filters")
                logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0)")
                return {
                    'criteria_1': 0.0,
                    'criteria_2': 0.0,
                    'criteria_3': 0.0,
                    'criteria_4': 0.0
                }
            elif finish_reason == 'length':
                logger.warning("‚ö†Ô∏è AI response was truncated due to length")
            elif finish_reason not in ['stop', None]:
                logger.warning(f"‚ö†Ô∏è Unexpected finish_reason: {finish_reason}")
        
        if not hasattr(choice, 'message') or not hasattr(choice.message, 'content'):
            logger.error("‚ùå Response missing message content")
            logger.error(f"   Response structure: {response}")
            logger.error(f"   Finish reason: {finish_reason}")
            raise ValueError("Response missing message content")
        
        # Extract response
        content = choice.message.content
        if content is None:
            logger.error("‚ùå Message content is None")
            logger.error(f"   Finish reason: {finish_reason}")
            raise ValueError("Message content is None")
        
        content = content.strip()
        logger.debug(f"AI response length: {len(content)} chars")
        logger.debug(f"AI response preview (first 500 chars): {content[:500]}")
        
        # Log full response at INFO level for debugging (will be logged at ERROR if parsing fails)
        if not content or len(content) < 10:
            logger.warning(f"‚ö†Ô∏è AI returned very short or empty response: '{content}'")
        
        # Check if content is empty
        if not content:
            logger.error("‚ùå Empty response from AI")
            raise ValueError("Empty response from AI")
        
        # Check if AI refused to process the request (English and Russian keywords)
        content_lower = content.lower()
        refusal_keywords = [
            # English
            "i'm sorry",
            "i can't assist",
            "i cannot assist",
            "i can't help",
            "i cannot help",
            "i'm unable",
            "i cannot",
            "sorry, but",
            "cannot process",
            "unable to process",
            "i apologize",
            "i'm not able",
            # Russian
            "–∏–∑–≤–∏–Ω–∏—Ç–µ",
            "–Ω–µ –º–æ–≥—É",
            "–Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å",
            "–Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å",
            "–Ω–µ –º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
            "–Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å",
            "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å",
            "–Ω–µ –º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å",
            "–Ω–µ –º–æ–≥—É –¥–∞—Ç—å",
            "–Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å",
            "–Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç",
            "–Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å json",
            "–Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
            "—è –Ω–µ –º–æ–≥—É",
            "—è –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å",
            "—è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –¥–∞—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å",
            "—è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç",
            "—è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å json",
            "—è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –¥–∞—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å json",
            "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        ]
        
        if any(keyword in content_lower for keyword in refusal_keywords):
            logger.warning(f"‚ö†Ô∏è AI refused to process the request: {content[:200]}")
            logger.warning("‚ö†Ô∏è This might be due to content moderation or policy restrictions")
            logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0)")
            # Return default values when AI refuses
            return {
                'criteria_1': 0.0,
                'criteria_2': 0.0,
                'criteria_3': 0.0,
                'criteria_4': 0.0
            }
        
        # Check if response looks like JSON before trying to parse
        # JSON should start with { or [ or be a number/string (but we expect an object)
        content_stripped = content.strip()
        if not (content_stripped.startswith('{') or content_stripped.startswith('[')):
            # Response doesn't look like JSON - might be an error message
            logger.warning(f"‚ö†Ô∏è AI response doesn't look like JSON (doesn't start with {{ or [)")
            logger.warning(f"   Response content (first 500 chars): {content[:500]}")
            logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0)")
            return {
                'criteria_1': 0.0,
                'criteria_2': 0.0,
                'criteria_3': 0.0,
                'criteria_4': 0.0
            }
        
        # Try to find JSON in response
        start_idx = content.find('{')
        end_idx = content.rfind('}') + 1
        
        if start_idx != -1 and end_idx > start_idx:
            json_str = content[start_idx:end_idx]
            try:
                result = json.loads(json_str)
            except json.JSONDecodeError as e:
                logger.error(f"‚ùå Failed to parse JSON from response: {e}")
                logger.error(f"   JSON string: {json_str[:500]}")  # Limit length for logging
                logger.error(f"   Full content length: {len(content)} chars")
                logger.error(f"   Full content (first 1000 chars): {content[:1000]}")
                logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0) due to JSON parse error")
                return {
                    'criteria_1': 0.0,
                    'criteria_2': 0.0,
                    'criteria_3': 0.0,
                    'criteria_4': 0.0
                }
        else:
            # Try to parse entire content as JSON
            try:
                result = json.loads(content)
            except json.JSONDecodeError as e:
                logger.error(f"‚ùå Failed to parse JSON from response: {e}")
                logger.error(f"   Full content length: {len(content)} chars")
                logger.error(f"   Full content (first 1000 chars): {content[:1000]}")
                logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0) due to JSON parse error")
                return {
                    'criteria_1': 0.0,
                    'criteria_2': 0.0,
                    'criteria_3': 0.0,
                    'criteria_4': 0.0
                }
        
        # Check all criteria are present
        if not all(key in result for key in ["criteria_1", "criteria_2", "criteria_3", "criteria_4"]):
            raise ValueError("Not all criteria present in response")
        
        # Validate and normalize values
        for key in ["criteria_1", "criteria_2", "criteria_4"]:
            value = float(result[key])
            if value not in [0.0, 1.0]:
                result[key] = 1.0 if value >= 0.5 else 0.0
            else:
                result[key] = value
        
        criteria_3 = float(result["criteria_3"])
        result["criteria_3"] = max(0.0, min(1.0, criteria_3))
        
        logger.info(f"‚úÖ Analysis completed")
        logger.info(f"   Criteria: {result}")
        
        return result
        
    except json.JSONDecodeError as e:
        logger.error(f"‚ùå JSON decode error analyzing text via AI: {str(e)}")
        logger.error(f"   This usually means AI returned invalid or empty response")
        # Try to log the response content if available
        try:
            if 'content' in locals():
                logger.error(f"   Response content length: {len(content)} chars")
                logger.error(f"   Response content (first 1000 chars): {content[:1000]}")
        except:
            pass
        logger.error(traceback.format_exc())
        # Return default values to avoid losing the call
        logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0) due to JSON parse error")
        return {
            'criteria_1': 0.0,
            'criteria_2': 0.0,
            'criteria_3': 0.0,
            'criteria_4': 0.0
        }
    except ValueError as e:
        logger.error(f"‚ùå Value error analyzing text via AI: {str(e)}")
        logger.error(traceback.format_exc())
        # Return default values for value errors (empty response, missing criteria, etc.)
        logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0) due to value error")
        return {
            'criteria_1': 0.0,
            'criteria_2': 0.0,
            'criteria_3': 0.0,
            'criteria_4': 0.0
        }
    except Exception as e:
        logger.error(f"‚ùå Unexpected error analyzing text via AI: {str(e)}")
        logger.error(traceback.format_exc())
        # For other errors, still return defaults to avoid losing calls
        logger.warning("‚ö†Ô∏è Returning default criteria (0,0,0,0) due to unexpected error")
        return {
            'criteria_1': 0.0,
            'criteria_2': 0.0,
            'criteria_3': 0.0,
            'criteria_4': 0.0
        }


def process_single_call(call_data: Dict) -> Optional[Dict]:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –∑–≤–æ–Ω–æ–∫: —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    call_id = call_data['id']
    url = call_data.get('url')
    team = call_data.get('team', '')  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞
    
    try:
        logger.info(f"{'='*60}")
        logger.info(f"Processing call ID: {call_id}")
        logger.info(f"URL: {url}")
        if team:
            logger.info(f"Team: {team}")
        
        # Check if URL is valid (not None and is a link)
        if url is None or not isinstance(url, str) or not (url.startswith('http://') or url.startswith('https://')):
            logger.warning(f"‚ö†Ô∏è Invalid URL for call {call_id}: {url}")
            logger.info(f"Returning result with zero criteria (0,0,0,0)")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –Ω—É–ª–µ–≤—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏
            criteria = {
                'criteria_1': 0.0,
                'criteria_2': 0.0,
                'criteria_3': 0.0,
                'criteria_4': 0.0
            }
            
            result = {
                'id': call_id,
                'text': '',
                'criteria': [
                    {'tag': 1, 'value': 0.0},
                    {'tag': 2, 'value': 0.0},
                    {'tag': 3, 'value': 0.0},
                    {'tag': 4, 'value': 0.0},
                ]
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
            with get_db() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT OR REPLACE INTO analyzed_calls 
                    (call_id, audio_url, transcription, criteria, analyzed_at)
                    VALUES (?, ?, ?, ?, ?)
                """, (call_id, url, '', json.dumps(criteria), datetime.now()))
                conn.commit()
            
            logger.info(f"‚úÖ Call {call_id} processed (no audio, criteria: 0,0,0,0)")
            logger.info(f"{'='*60}")
            
            return result
        
        # 1. Transcribe audio
        text = transcribe_audio(url)
        
        # 2. Analyze text (pass team for selecting appropriate script)
        criteria = analyze_call_text(text, team=team)
        
        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = {
            'id': call_id,
            'text': text,
            'criteria': [
                {'tag': 1, 'value': criteria['criteria_1']},
                {'tag': 2, 'value': criteria['criteria_2']},
                {'tag': 3, 'value': criteria['criteria_3']},
                {'tag': 4, 'value': criteria['criteria_4']},
            ]
        }
        
        # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
        with get_db() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT OR REPLACE INTO analyzed_calls 
                (call_id, audio_url, transcription, criteria, analyzed_at)
                VALUES (?, ?, ?, ?, ?)
            """, (call_id, url, text, json.dumps(criteria), datetime.now()))
            conn.commit()
        
        logger.info(f"‚úÖ Call {call_id} successfully processed and saved to DB")
        logger.info(f"üìä Analysis results:")
        logger.info(f"   ‚Ä¢ Criteria 1 (call was made): {criteria['criteria_1']}")
        logger.info(f"   ‚Ä¢ Criteria 2 (work related): {criteria['criteria_2']}")
        logger.info(f"   ‚Ä¢ Criteria 3 (script compliance): {criteria['criteria_3']}")
        logger.info(f"   ‚Ä¢ Criteria 4 (positive outcome): {criteria['criteria_4']}")
        logger.info(f"{'='*60}")
        
        return result
        
    except Exception as e:
        logger.error(f"‚ùå Error processing call {call_id}: {str(e)}")
        logger.error(traceback.format_exc())
        return None


# ==================== –†–ê–ë–û–¢–ê –° API ====================

def fetch_calls_from_api(count: int = 10) -> List[Dict]:
    """
    –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–≤–æ–Ω–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ API
    GET /callsAnalyze?count=N
    """
    try:
        logger.info(f"Requesting calls from API (count={count})...")
        logger.info(f"URL: {API_GET_CALLS}")
        
        response = make_authenticated_request(
            'GET',
            API_GET_CALLS,
            params={'count': count},
            timeout=API_REQUEST_TIMEOUT
        )
        response.raise_for_status()
        
        data = response.json()
        calls = data.get('data', [])
        
        logger.info(f"‚úÖ Received calls: {len(calls)}")
        
        return calls
        
    except Exception as e:
        logger.error(f"‚ùå Error requesting calls from API: {str(e)}")
        logger.error(traceback.format_exc())
        return []


def send_result_to_api(result: Dict) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤ API
    POST /callsAnalyze/result
    """
    try:
        call_id = result['id']
        logger.info(f"Sending result for call {call_id} to API...")
        logger.debug(f"Data: {json.dumps(result, ensure_ascii=False)}")
        
        response = make_authenticated_request(
            'POST',
            API_POST_RESULTS,
            json=result,
            timeout=API_REQUEST_TIMEOUT
        )
        response.raise_for_status()
        
        logger.info(f"‚úÖ Result for call {call_id} successfully sent (HTTP {response.status_code})")
        
        # Update status in DB
        with get_db() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                UPDATE analyzed_calls 
                SET sent_to_api = 1, sent_at = ?
                WHERE call_id = ?
            """, (datetime.now(), call_id))
            conn.commit()
        
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Error sending result to API: {str(e)}")
        logger.error(traceback.format_exc())
        return False


# ==================== –û–°–ù–û–í–ù–ê–Ø –ó–ê–î–ê–ß–ê ====================

def process_calls_job():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–æ–≤:
    1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–≤–æ–Ω–∫–∏ –∏–∑ API (count=10)
    2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ö
    3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
    
    Returns:
        int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ (0 –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±—ã–ª –ø—É—Å—Ç—ã–º)
    """
    job_start_time = datetime.now()
    logger.info("")
    logger.info(f"{'#'*80}")
    logger.info(f"### CALL ANALYSIS TASK STARTED")
    logger.info(f"### Time: {job_start_time.strftime('%Y-%m-%d %H:%M:%S')}")
    logger.info(f"{'#'*80}")
    
    try:
        # 1. Get calls from API (count=10)
        calls = fetch_calls_from_api(count=10)
        
        if not calls:
            logger.warning("No calls to process")
            return 0
        
        # 2. Process each call
        results = []
        successful = 0
        failed = 0
        
        for i, call in enumerate(calls, 1):
            logger.info(f"\n--- Call {i}/{len(calls)} ---")
            
            result = process_single_call(call)
            
            if result:
                results.append(result)
                successful += 1
            else:
                failed += 1
        
        # 3. Send results back to API
        logger.info(f"\n{'='*60}")
        logger.info("Sending results to API...")
        
        sent_count = 0
        for result in results:
            if send_result_to_api(result):
                sent_count += 1
            # Small pause between requests
            time.sleep(SEND_RESULTS_DELAY)
        
        # 4. Summary
        job_end_time = datetime.now()
        duration = (job_end_time - job_start_time).total_seconds()
        
        logger.info(f"\n{'#'*80}")
        logger.info(f"### TASK COMPLETED")
        logger.info(f"### Execution time: {duration:.2f} sec")
        logger.info(f"### Total calls: {len(calls)}")
        logger.info(f"### Successfully processed: {successful}")
        logger.info(f"### Sent to API: {sent_count}")
        logger.info(f"### Errors: {failed}")
        logger.info(f"{'#'*80}")
        logger.info("")
        
        return len(calls)
        
    except Exception as e:
        logger.error(f"‚ùå Critical error during task execution: {str(e)}")
        logger.error(traceback.format_exc())
        return 0


# ==================== –§–£–ù–ö–¶–ò–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ====================

def restore_unsent_results():
    """
    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ API
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
    """
    logger.info("Checking unsent results in DB...")
    
    try:
        with get_db() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                SELECT call_id, transcription, criteria
                FROM analyzed_calls
                WHERE sent_to_api = 0
            """)
            unsent = cursor.fetchall()
        
        if not unsent:
            logger.info("‚úÖ All results sent")
            return
        
        logger.info(f"Found unsent results: {len(unsent)}")
        
        for row in unsent:
            call_id = row['call_id']
            text = row['transcription']
            criteria = json.loads(row['criteria'])
            
            result = {
                'id': call_id,
                'text': text,
                'criteria': [
                    {'tag': 1, 'value': criteria['criteria_1']},
                    {'tag': 2, 'value': criteria['criteria_2']},
                    {'tag': 3, 'value': criteria['criteria_3']},
                    {'tag': 4, 'value': criteria['criteria_4']},
                ]
            }
            
            send_result_to_api(result)
            time.sleep(SEND_RESULTS_DELAY)
        
        logger.info("‚úÖ Recovery completed")
        
    except Exception as e:
        logger.error(f"‚ùå Error recovering results: {str(e)}")
        logger.error(traceback.format_exc())


# ==================== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ====================

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä"""
    try:
        logger.info("="*80)
        logger.info("CALL ANALYSIS SERVER STARTING")
        logger.info("="*80)
        logger.info(f"API GET: {API_GET_CALLS}")
        logger.info(f"API POST: {API_POST_RESULTS}")
        logger.info(f"Calls per batch: 10")
        logger.info(f"Pause when list is empty: 15 minutes")
        logger.info(f"Database: {DATABASE_PATH}")
        logger.info(f"Log file: {LOG_FILE}")
        logger.info(f"Whisper model: {WHISPER_MODEL_SIZE}")
        logger.info(f"Device: {WHISPER_DEVICE}")
        logger.info(f"Beam size: {WHISPER_BEAM_SIZE}")
        logger.info(f"OpenAI model: {OPENAI_MODEL}")
        logger.info("="*80)
        
        # Initialization
        logger.info("Initializing...")
        init_database()
        
        # Setup authorization in session
        logger.info("Setting up authorization...")
        update_session_auth()
        
        # Load Whisper model once at startup (will be reused)
        logger.info("Loading Whisper model...")
        model_loaded = load_whisper_model()
        if model_loaded is not None:
            logger.info("‚úÖ Model loaded and will be reused for all transcriptions")
        else:
            logger.warning("‚ö†Ô∏è Model not loaded at startup, will be loaded on first use")
        
        # Restore unsent results
        restore_unsent_results()
        
        logger.info("")
        logger.info("‚úÖ Server ready")
        logger.info("Mode: continuous processing of 10 calls per batch")
        logger.info("If list is empty - pause 15 minutes")
        logger.info("Press Ctrl+C to stop")
        logger.info("")
        
        # Run immediately on startup if configured
        if RUN_ON_STARTUP:
            logger.info("Starting processing immediately on startup...")
            process_calls_job()
        
        # Infinite loop for processing calls
        while True:
            try:
                # Process 10 calls
                processed_count = process_calls_job()
                
                if processed_count == 0:
                    # If list is empty - pause 15 minutes
                    logger.info("")
                    logger.info("="*80)
                    logger.info("Call list is empty. Pausing for 15 minutes...")
                    logger.info("="*80)
                    logger.info("")
                    time.sleep(15 * 60)  # 15 minutes = 900 seconds
                else:
                    # If calls were processed - immediately get new ones (no pause)
                    logger.info("Immediately requesting next batch of calls...")
                    logger.info("")
                    
            except KeyboardInterrupt:
                raise
            except Exception as e:
                logger.error(f"‚ùå Error in processing loop: {str(e)}")
                logger.error(traceback.format_exc())
                # Small pause before next attempt
                time.sleep(60)
            
    except KeyboardInterrupt:
        logger.info("")
        logger.info("="*80)
        logger.info("SERVER STOPPED (Ctrl+C)")
        logger.info("="*80)
    except Exception as e:
        logger.error(f"‚ùå Critical server error: {str(e)}")
        logger.error(f"‚ùå Error type: {type(e).__name__}")
        logger.error(traceback.format_exc())
        # –ù–ï –¥–µ–ª–∞–µ–º raise - –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
        # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        logger.error("‚ö†Ô∏è Server will continue running despite initialization error")
        logger.error("‚ö†Ô∏è Some features may not work until the issue is resolved")
        # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ
        # –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
        try:
            logger.info("Attempting to continue with main processing loop...")
            while True:
                try:
                    # Process 10 calls
                    processed_count = process_calls_job()
                    
                    if processed_count == 0:
                        # If list is empty - pause 15 minutes
                        logger.info("")
                        logger.info("="*80)
                        logger.info("Call list is empty. Pausing for 15 minutes...")
                        logger.info("="*80)
                        logger.info("")
                        time.sleep(15 * 60)  # 15 minutes = 900 seconds
                    else:
                        # If calls were processed - immediately get new ones (no pause)
                        logger.info("Immediately requesting next batch of calls...")
                        logger.info("")
                        
                except KeyboardInterrupt:
                    raise
                except Exception as e:
                    logger.error(f"‚ùå Error in processing loop: {str(e)}")
                    logger.error(traceback.format_exc())
                    # Small pause before next attempt
                    time.sleep(60)
        except KeyboardInterrupt:
            logger.info("")
            logger.info("="*80)
            logger.info("SERVER STOPPED (Ctrl+C)")
            logger.info("="*80)


if __name__ == "__main__":
    main()

